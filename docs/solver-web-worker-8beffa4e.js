var yt=Object.defineProperty;var wt=(P,w,C)=>w in P?yt(P,w,{enumerable:!0,configurable:!0,writable:!0,value:C}):P[w]=C;var p=(P,w,C)=>(wt(P,typeof w!="symbol"?w+"":w,C),C);(function(){"use strict";var P=(i=>(i[i.LEFT=0]="LEFT",i[i.UP=1]="UP",i[i.RIGHT=2]="RIGHT",i[i.DOWN=3]="DOWN",i))(P||{});const w=i=>{switch(i){case 1:return 3;case 2:return 0;case 3:return 1;case 0:return 2}},C=i=>{switch(i){case 1:return 2;case 2:return 3;case 3:return 0;case 0:return 1}},k=new Map;k.set("u",1),k.set("l",0),k.set("d",3),k.set("r",2);class A{constructor(t,e){p(this,"_x",0);p(this,"_y",0);this._x=t,this._y=e}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}clone(){return new A(this._x,this._y)}normalize(){const t=this.size();return new A(this._x/t,this._y/t)}isEqualTo(t){return this.x===t.x&&this.y===t.y}isDifferentOf(t){return!this.isEqualTo(t)}calculateOffset(t){const e=new A(0,0);return t===P.LEFT?e.x-=1:t===P.RIGHT&&(e.x+=1),t===P.UP?e.y-=1:t===P.DOWN&&(e.y+=1),this.sum(e)}subtract(t){return new A(this.x-t.x,this.y-t.y)}sum(t){return new A(this.x+t.x,this.y+t.y)}multiply(t){return new A(this.x*t,this.y*t)}size(){return Math.sqrt(this.quadractricSize())}quadractricSize(){return this.x*this.x+this.y+this.y}}var Z=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function tt(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var K={},et={get exports(){return K},set exports(i){K=i}},q={},it={get exports(){return q},set exports(i){q=i}};(function(i,t){(function(){var e,n,r,o,l,c,g,T,x,S,L,X,z,R,I;r=Math.floor,S=Math.min,n=function(s,a){return s<a?-1:s>a?1:0},x=function(s,a,u,h,m){var f;if(u==null&&(u=0),m==null&&(m=n),u<0)throw new Error("lo must be non-negative");for(h==null&&(h=s.length);u<h;)f=r((u+h)/2),m(a,s[f])<0?h=f:u=f+1;return[].splice.apply(s,[u,u-u].concat(a)),a},c=function(s,a,u){return u==null&&(u=n),s.push(a),R(s,0,s.length-1,u)},l=function(s,a){var u,h;return a==null&&(a=n),u=s.pop(),s.length?(h=s[0],s[0]=u,I(s,0,a)):h=u,h},T=function(s,a,u){var h;return u==null&&(u=n),h=s[0],s[0]=a,I(s,0,u),h},g=function(s,a,u){var h;return u==null&&(u=n),s.length&&u(s[0],a)<0&&(h=[s[0],a],a=h[0],s[0]=h[1],I(s,0,u)),a},o=function(s,a){var u,h,m,f,v,M;for(a==null&&(a=n),f=function(){M=[];for(var O=0,F=r(s.length/2);0<=F?O<F:O>F;0<=F?O++:O--)M.push(O);return M}.apply(this).reverse(),v=[],h=0,m=f.length;h<m;h++)u=f[h],v.push(I(s,u,a));return v},z=function(s,a,u){var h;if(u==null&&(u=n),h=s.indexOf(a),h!==-1)return R(s,0,h,u),I(s,h,u)},L=function(s,a,u){var h,m,f,v,M;if(u==null&&(u=n),m=s.slice(0,a),!m.length)return m;for(o(m,u),M=s.slice(a),f=0,v=M.length;f<v;f++)h=M[f],g(m,h,u);return m.sort(u).reverse()},X=function(s,a,u){var h,m,f,v,M,O,F,_,W;if(u==null&&(u=n),a*10<=s.length){if(f=s.slice(0,a).sort(u),!f.length)return f;for(m=f[f.length-1],F=s.slice(a),v=0,O=F.length;v<O;v++)h=F[v],u(h,m)<0&&(x(f,h,0,null,u),f.pop(),m=f[f.length-1]);return f}for(o(s,u),W=[],M=0,_=S(a,s.length);0<=_?M<_:M>_;0<=_?++M:--M)W.push(l(s,u));return W},R=function(s,a,u,h){var m,f,v;for(h==null&&(h=n),m=s[u];u>a;){if(v=u-1>>1,f=s[v],h(m,f)<0){s[u]=f,u=v;continue}break}return s[u]=m},I=function(s,a,u){var h,m,f,v,M;for(u==null&&(u=n),m=s.length,M=a,f=s[a],h=2*a+1;h<m;)v=h+1,v<m&&!(u(s[h],s[v])<0)&&(h=v),s[a]=s[h],a=h,h=2*a+1;return s[a]=f,R(s,M,a,u)},e=function(){s.push=c,s.pop=l,s.replace=T,s.pushpop=g,s.heapify=o,s.updateItem=z,s.nlargest=L,s.nsmallest=X;function s(a){this.cmp=a??n,this.nodes=[]}return s.prototype.push=function(a){return c(this.nodes,a,this.cmp)},s.prototype.pop=function(){return l(this.nodes,this.cmp)},s.prototype.peek=function(){return this.nodes[0]},s.prototype.contains=function(a){return this.nodes.indexOf(a)!==-1},s.prototype.replace=function(a){return T(this.nodes,a,this.cmp)},s.prototype.pushpop=function(a){return g(this.nodes,a,this.cmp)},s.prototype.heapify=function(){return o(this.nodes,this.cmp)},s.prototype.updateItem=function(a){return z(this.nodes,a,this.cmp)},s.prototype.clear=function(){return this.nodes=[]},s.prototype.empty=function(){return this.nodes.length===0},s.prototype.size=function(){return this.nodes.length},s.prototype.clone=function(){var a;return a=new s,a.nodes=this.nodes.slice(0),a},s.prototype.toArray=function(){return this.nodes.slice(0)},s.prototype.insert=s.prototype.push,s.prototype.top=s.prototype.peek,s.prototype.front=s.prototype.peek,s.prototype.has=s.prototype.contains,s.prototype.copy=s.prototype.clone,s}(),function(s,a){return i.exports=a()}(this,function(){return e})}).call(Z)})(it),function(i){i.exports=q}(et);var ot=tt(K),d=(i=>(i[i.empty=0]="empty",i[i.box=9]="box",i[i.target=64]="target",i[i.wall=100]="wall",i[i.hero=52]="hero",i[i.floor=89]="floor",i[i.boxOnTarget=7]="boxOnTarget",i[i.treadmil=71]="treadmil",i[i.spring=73]="spring",i[i.oily=49]="oily",i[i.oneWayDoor=47]="oneWayDoor",i))(d||{});const y=new Map;y.set("-",0),y.set(" ",89),y.set("f",89),y.set("t",71),y.set("w",47),y.set("o",49),y.set("s",73),y.set("#",100),y.set(".",64),y.set("$",9),y.set("b",9),y.set("@",52),y.set("p",52);const H=i=>{for(let[t,e]of y.entries())if(e===i)return t},$=new Map;$.set(/\*/g,`[${H(9).concat(H(64))}]`),$.set(/\+/g,`[${H(52).concat(H(64))}]`);var B=(i=>(i[i.STAND=0]="STAND",i[i.LEFT=1]="LEFT",i[i.UP=2]="UP",i[i.RIGHT=3]="RIGHT",i[i.DOWN=4]="DOWN",i))(B||{});const st=i=>{switch(i){case 1:return P.LEFT;case 2:return P.UP;case 3:return P.RIGHT;case 4:return P.DOWN}};var E=(i=>(i[i.ADD_CANDIDATE=0]="ADD_CANDIDATE",i[i.POP_CANDIDATE=1]="POP_CANDIDATE",i[i.MOVE_ANALYSYS=2]="MOVE_ANALYSYS",i[i.BREATHING_TIME=3]="BREATHING_TIME",i[i.HASH_CALCULATION=4]="HASH_CALCULATION",i[i.VISISTED_LIST_CHECK=5]="VISISTED_LIST_CHECK",i))(E||{});class nt{constructor(){p(this,"metricMap");p(this,"startTime");this.startTime=new Date().getTime(),this.metricMap=new Map}async add(t,e){const n=new Date().getTime(),r=await e(),o=new Date().getTime(),l=this.metricMap.get(t)||0;return this.metricMap.set(t,o-n+l),r}log(){console.log(`Metrics (${new Date().getTime()-this.startTime}ms)`);let t=0;this.metricMap.forEach(e=>t+=e);for(let[e,n]of this.metricMap.entries())console.log(`	${E[e]}: ${n}ms (${Math.trunc(1e3*n/t)/10}%)`)}}var rt="/nuclear-defender/floor_texture-2d04b708.jpg",at="/nuclear-defender/sokoban_tilesheet_new-f678deda.png",lt="/nuclear-defender/wall_sprites-943b3868.png",ut="/nuclear-defender/transparent-selector-4fd349b9.png",ct="/nuclear-defender/thumbnail-faf1c6ed.png",ht="/nuclear-defender/sokoban_tilessheet_normal-602391dc.png";class dt{distance(t,e){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}}const G=.79,Y=50,j=40,pt={frameRate:8,updateCycleInMs:175,floorTextureKey:"floorTexture",floorTexture:rt,selectorTextureKey:"selectorTextureKey",selectorTextureFile:ut,thumbnailTextureKey:"thumbNailTextureKey",thumbnailTextureFile:ct,tiles:{verticalPerspective:G,verticalSize:Y,horizontalSize:j,wallSheetKey:"wallSheetKey",wallSheetAsset:lt,spriteSheetKey:"tiles",sheetAsset:at,sheetAssetNormal:ht,tilemapKey:"tilemap",layerName:"Level",tilesetName:"sokoban",numOfFramesPerLine:36,framesPerAnimation:3},world:{tileSize:{vertical:Math.trunc(Y*G),horizontal:j},scaleLimits:{max:1.15,min:.15},scale:0,mapLimits:{lines:20,rows:20,features:30}},screenRatio:.7,gameWidth:800,gameHeight:600,colors:{foregroundColor:"#d6d6d6",radioactive:"#d4fa00",controlled:"#ff3c91",background:"#dddddd",ambientColor:"#BBBBBB"},html:{gameScene:{}},store:{numberOfEnabledLevelsKey:"numberOfEnabledLevelsKey",currentSelectedIndexKey:"currentSelectedIndexKey",customLevelKey:"customLevelKey",resolvedLevelsKey:"resolvedLevelsKey"},solver:{distanceCalculator:new dt,distanceToTheClosestBox:!1},debug:{mapEditorValidation:!1,solver:{metrics:!0,estimator:!0,iterationNumber:!1}}};class J{constructor(t){p(this,"staticMap");this.staticMap=t.strippedStaticMapMap}getStaticFeaturesAtPosition(t){return t.x<this.staticMap.width&&t.y<this.staticMap.height&&t.x>=0&&t.y>=0?this.staticMap.strippedFeatureLayeredMatrix[t.y][t.x]:[]}}class ft extends J{deadLocked(t){return t.boxes.filter(e=>e.currentPosition.isDifferentOf(e.nextPosition)).some(e=>this.boxIsDeadLocked(e))}boxIsDeadLocked(t){const e=t.direction,n=t.nextPosition.calculateOffset(e);return!!(this.getStaticFeaturesAtPosition(n).some(r=>r.code===d.wall)&&this.checkTrappedBoxInCorner(t,e))}checkTrappedBoxInCorner(t,e){if(this.getStaticFeaturesAtPosition(t.nextPosition).some(x=>x.code===d.target||x.code===d.spring||x.code===d.treadmil))return!1;const r=C(e),o=t.nextPosition.calculateOffset(r),l=w(r),c=t.nextPosition.calculateOffset(l),g=this.staticMap.strippedFeatureLayeredMatrix[o.y][o.x],T=this.staticMap.strippedFeatureLayeredMatrix[c.y][c.x];return!!(g.some(x=>x.code===d.wall)||T.some(x=>x.code===d.wall))}}class gt extends J{deadLocked(t){return t.boxes.filter(e=>e.currentPosition.isDifferentOf(e.nextPosition)).some(e=>this.boxIsDeadLocked(e,t.boxes))}boxIsDeadLocked(t,e){if(this.getStaticFeaturesAtPosition(t.nextPosition).some(o=>o.code===d.spring||o.code===d.treadmil))return!1;const n=t.direction,r=t.nextPosition.calculateOffset(n);return!!(this.getStaticFeaturesAtPosition(r).some(o=>o.code===d.wall)&&this.wallAheadCheck(n,t,r,e))}wallAheadCheck(t,e,n,r){let o;return t===P.DOWN||t===P.UP?o=this.verticalLineSegment(e.nextPosition,n,r):o=this.horizontalLineSegment(e.nextPosition,n,r),o.boxes>o.targets&&o.emptiesAhead<2}verticalLineSegment(t,e,n){let r=0,o=0;for(let c=0;c<this.staticMap.width;++c)this.staticMap.strippedFeatureLayeredMatrix[t.y][c].some(x=>x.code===d.target)&&++o,this.staticMap.strippedFeatureLayeredMatrix[e.y][c].some(x=>x.code!==d.wall&&x.code!==d.empty)&&++r;const l=n.filter(c=>c.nextPosition.y===t.y).reduce((c,g)=>c+1,0);return{emptiesAhead:r,targets:o,boxes:l}}horizontalLineSegment(t,e,n){let r=0,o=0;for(let c=0;c<this.staticMap.height;++c)this.staticMap.strippedFeatureLayeredMatrix[c][t.x].some(x=>x.code===d.target)&&++o,this.staticMap.strippedFeatureLayeredMatrix[c][e.x].some(x=>x.code!==d.wall&&x.code!==d.empty)&&++r;const l=n.filter(c=>c.nextPosition.x===t.x).reduce((c,g)=>c+1,0);return{emptiesAhead:r,targets:o,boxes:l}}}class xt{constructor(t){p(this,"targets");p(this,"distanceCalculator");p(this,"strippedMap");p(this,"deadlockDetectors");this.strippedMap=t.strippedMap,this.distanceCalculator=t.distanceCalculator,this.targets=t.staticFeatures.get(d.target),this.deadlockDetectors=[new ft({strippedStaticMapMap:this.strippedMap}),new gt({strippedStaticMapMap:this.strippedMap})]}analyse(t){const e=this.deadlockDetectors.some(o=>o.deadLocked(t)),r=t.boxes.filter(o=>o.currentPosition.isDifferentOf(o.nextPosition)).find(o=>t.hero.nextPosition.isEqualTo(o.currentPosition)&&t.hero.direction===o.direction);return{boxesMoved:[],pushedBox:r?{id:r.id,direction:r.direction}:void 0,sumOfEveryBoxToTheClosestTarget:this.sumOfEveryBoxToTheClosestAvailableTarget(t),isDeadLocked:e}}sumOfEveryBoxToTheClosestAvailableTarget(t){let e=this.targets;return t.boxes.reduce((n,r)=>{const o=e.reduce((l,c,g)=>{const T=this.distanceCalculator.distance(c,r.nextPosition);return l.value===-1||T<l.value?{value:T,index:g}:l},{value:-1,index:-1});return e=e.filter((l,c)=>c!==o.index),n+o.value},0)}sumOfEveryBoxToTheClosestTarget(t){return t.boxes.reduce((e,n)=>{const r=this.targets.reduce((o,l,c)=>{const g=this.distanceCalculator.distance(l,n.nextPosition);return o.value===-1||g<o.value?{value:g,index:c}:o},{value:-1,index:-1});return e+r.value},0)}}class mt{constructor(t){p(this,"coordinator");p(this,"position");this.coordinator=t.coordinator,this.position=new A(0,0)}allowEnteringMovement(){return!1}allowLeavingMovement(){return!0}getTile(){return d.hero}getPosition(){return this.position}getOrientation(){}act(t){this.position=t.hero.position;let e=!1;if(t.hero.action!==B.STAND){const n=st(t.hero.action);if(!this.coordinator.canFeatureLeavePosition({point:this.position,orientation:n}))return!1;const r=t.hero.position.calculateOffset(n),o={point:r,orientation:n};if(this.featureAheadAllowsMovement(o)){e=!0,this.coordinator.moveHero(n);const l=t.boxes.find(c=>c.nextPosition.isEqualTo(r));l&&this.coordinator.moveFeature(l,n)}}return e}featureAheadAllowsMovement(t){const e=this.coordinator.getFeaturesBlockingMoveIntoPosition(t);if(e.length>=1){if(e.length===1&&e[0].code===d.box){if(!this.coordinator.canFeatureLeavePosition(t))return!1;const n=t.point.calculateOffset(t.orientation);return this.coordinator.getFeaturesBlockingMoveIntoPosition({point:n,orientation:t.orientation}).length<=0}return!1}return!0}}class Tt{constructor(t){p(this,"position");p(this,"orientation");p(this,"coordinator");p(this,"nextTilePosition");this.position=t.position,this.orientation=t.orientation,this.coordinator=t.coordinator,this.nextTilePosition=this.position.calculateOffset(this.orientation)}act(t){let e=!1;return t.boxes.filter(n=>n.currentPosition.isEqualTo(this.position)&&n.currentPosition.isEqualTo(n.nextPosition)).forEach(n=>{const r=this.coordinator.getFeaturesBlockingMoveIntoPosition({point:this.nextTilePosition,orientation:this.orientation});if(r.length<=0)this.coordinator.moveFeature(n,this.orientation),e=!0;else{const o=r.find(l=>D.PUSHER_FEATURES.has(l.code));o&&r.some(l=>{var S,L;const c=l.code===d.hero||l.code===d.box,g=(S=l.currentPosition)==null?void 0:S.isDifferentOf(l.nextPosition),T=l.direction!==o.direction;return c&&((L=l.currentPosition)==null?void 0:L.isEqualTo(this.nextTilePosition))&&g&&T})&&(this.coordinator.moveFeature(n,this.orientation),e=!0)}}),e}allowEnteringMovement(t){return this.orientation===w(t)}allowLeavingMovement(t){return this.orientation!==w(t)}getTile(){return d.spring}getPosition(){return this.position}getOrientation(){return this.orientation}}class vt{constructor(t){p(this,"position");p(this,"orientation");p(this,"coordinator");p(this,"nextTilePosition");this.position=t.position,this.orientation=t.orientation,this.coordinator=t.coordinator,this.nextTilePosition=this.position.calculateOffset(this.orientation)}act(t){let e=!1;return t.boxes.filter(n=>n.currentPosition.isEqualTo(this.position)&&n.currentPosition.isEqualTo(n.nextPosition)).forEach(n=>{const r=this.coordinator.getFeaturesBlockingMoveIntoPosition({point:this.nextTilePosition,orientation:this.orientation});if(r.length<=0)e=this.move(n);else{const o=r.find(l=>D.PUSHER_FEATURES.has(l.code));o&&r.some(l=>{var S,L;const c=l.code===d.hero||l.code===d.box,g=(S=l.currentPosition)==null?void 0:S.isDifferentOf(l.nextPosition),T=l.direction!==o.direction;return c&&((L=l.currentPosition)==null?void 0:L.isEqualTo(this.nextTilePosition))&&g&&T})&&(e=this.move(n))}}),e}move(t){return this.coordinator.moveFeature(t,this.orientation),!0}allowEnteringMovement(){return!0}allowLeavingMovement(){return!0}getTile(){return d.spring}getPosition(){return this.position}getOrientation(){return this.orientation}}class Pt{constructor(t){p(this,"position");p(this,"coordinator");this.position=t.position,this.coordinator=t.coordinator}act(t){var r;let e=!1;const n=(r=t.lastActionResult)==null?void 0:r.boxes.find(o=>o.nextPosition.isEqualTo(this.position)&&o.currentPosition.isDifferentOf(o.nextPosition));if(n){const o=t.boxes.find(g=>g.id===n.id),l=n.direction,c=this.position.calculateOffset(l);if(c.isDifferentOf(t.hero.position)){const g=this.coordinator.getFeaturesBlockingMoveIntoPosition({point:c,orientation:l}),T=o.currentPosition.isDifferentOf(o.nextPosition);g.length<=0&&!T&&(this.coordinator.moveFeature(o,l),e=!0)}}return e}allowEnteringMovement(){return!0}allowLeavingMovement(){return!0}getOrientation(){}getTile(){return d.oily}getPosition(){return this.position}}class Mt{constructor(t){p(this,"position");p(this,"orientation");this.position=t.position,this.orientation=t.orientation}act(){return!1}allowEnteringMovement(t){return this.orientation===t}allowLeavingMovement(t){return this.orientation===t||this.orientation===w(t)}getTile(){return d.oneWayDoor}getPosition(){return this.position}getOrientation(){return this.orientation}}const U=class{constructor(t){p(this,"strippedMap");p(this,"movementHandlers",[]);p(this,"hero");p(this,"boxes");this.strippedMap=t.strippedMap,this.movementHandlers.push(new mt({coordinator:this})),this.movementHandlers.push(...this.findTileOrientedPositions(d.spring,e=>new Tt(e))),this.movementHandlers.push(...this.findTileOrientedPositions(d.oily,e=>new Pt(e))),this.movementHandlers.push(...this.findTileOrientedPositions(d.oneWayDoor,e=>new Mt(e))),this.movementHandlers.push(...this.findTileOrientedPositions(d.treadmil,e=>new vt(e)))}moveHero(t){this.moveFeature(this.hero,t)}moveFeature(t,e){t.direction=e,t.currentPosition=t.nextPosition,t.nextPosition=t.currentPosition.calculateOffset(e)}update(t){this.hero=this.initializeFeature(t.hero,d.hero),this.boxes=t.boxes.map(r=>this.initializeFeature(r,d.box));const e={hero:{action:t.heroAction,position:this.hero.nextPosition},boxes:this.boxes,lastActionResult:t.lastActionResult},n=this.movementHandlers.reduce((r,o)=>o.act(e)||r,!1);return{hero:this.hero,boxes:this.boxes,mapChanged:n}}canFeatureLeavePosition(t){const e=this.getFeaturesAtPosition(t.point);return this.movementHandlers.filter(r=>e.some(o=>o.code===r.getTile()&&t.point.isEqualTo(r.getPosition()))).every(r=>r.allowLeavingMovement(t.orientation))}getFeaturesBlockingMoveIntoPosition(t){const e=[],n=this.getFeaturesAtPosition(t.point);e.push(...n.filter(o=>U.BLOCKER_FEATURES.has(o.code)).map(o=>o));const r=this.getStaticFeaturesAtPosition(t.point);return e.push(...this.movementHandlers.filter(o=>r.some(l=>l.code===o.getTile()&&t.point.isEqualTo(o.getPosition()))).filter(o=>!o.allowEnteringMovement(t.orientation)).map(o=>({code:o.getTile(),direction:o.getOrientation(),nextPosition:t.point,currentPosition:t.point,id:-1}))),[...new Set(e)]}initializeFeature(t,e){return{id:t.id,currentPosition:t.point,nextPosition:t.point,direction:void 0,code:e}}getFeaturesAtPosition(t){let e=this.getDynamicFeaturesAtPosition(t);return e=e.concat(this.getStaticFeaturesAtPosition(t)),e}getDynamicFeaturesAtPosition(t){var n,r,o;let e=[];return((n=this.hero)!=null&&n.currentPosition.isEqualTo(t)||(r=this.hero)!=null&&r.nextPosition.isEqualTo(t))&&e.push(this.hero),(o=this.boxes)==null||o.filter(l=>l.currentPosition.isEqualTo(t)||l.nextPosition.isEqualTo(t)).forEach(l=>e.push(l)),e}getStaticFeaturesAtPosition(t){const e=[];let n=0;if(t.x<this.strippedMap.width&&t.y<this.strippedMap.height&&t.x>=0&&t.y>=0){const r=this.strippedMap.strippedFeatureLayeredMatrix[t.y][t.x];e.push(...r.map(o=>({code:o.code,currentPosition:t,direction:o.orientation,id:++n,nextPosition:t})))}return e}findTileOrientedPositions(t,e){const n=[];return this.strippedMap.strippedFeatureLayeredMatrix.forEach((r,o)=>r.forEach((l,c)=>l.forEach(g=>{g.code===t&&n.push(e({position:new A(c,o),orientation:g.orientation,coordinator:this}))}))),n}};let D=U;p(D,"BLOCKER_FEATURES",new Set([d.box,d.hero,d.wall,d.empty])),p(D,"PUSHER_FEATURES",new Set([d.hero,d.treadmil,d.spring]));const V=class{constructor(t){p(this,"iterations");p(this,"movementCoordinator");p(this,"candidatesToVisit",new ot((t,e)=>t.distanceSum-e.distanceSum));p(this,"candidatesVisitedSet",new Set);p(this,"strippedMap");p(this,"movementAnalyser");p(this,"metricEmitter");p(this,"aborted");p(this,"startTime");this.strippedMap=t.strippedMap,this.iterations=0,this.aborted=!1,this.movementCoordinator=new D({strippedMap:this.strippedMap}),this.movementAnalyser=new xt({staticFeatures:t.staticFeatures,strippedMap:this.strippedMap,distanceCalculator:pt.solver.distanceCalculator}),this.metricEmitter=new nt}abort(){console.log("aborting current solution finding"),this.aborted=!0,this.candidatesToVisit.clear()}async solve(t){this.startTime=new Date().getTime();const e=await this.startAlgorithm(t);return{aborted:this.aborted,actions:e==null?void 0:e.actions,boxesLine:e==null?void 0:e.boxesLine,counterIntuitiveMoves:e==null?void 0:e.counterIntuitiveMoves,iterations:this.iterations,totalTime:Date.now()-this.startTime}}async startAlgorithm(t){const e=t.get(d.hero)[0],n=t.get(d.box),r={boxesLine:0,counterIntuitiveMoves:0,lastPushedBox:{id:-1,direction:P.UP},actions:[],hero:{point:e,id:0},boxes:n.map((c,g)=>({point:c,id:g+1})),distanceSum:0};r.hash=await this.metricEmitter.add(E.HASH_CALCULATION,()=>this.calculateHashOfSolution(r)),this.candidatesToVisit.push(r);let o,l=r;for(;l&&!this.aborted&&(++this.iterations,o=await this.checkSolution(l),!o);)l=await this.metricEmitter.add(E.POP_CANDIDATE,()=>this.candidatesToVisit.pop());return this.metricEmitter.log(),o}async checkSolution(t){if(await this.metricEmitter.add(E.VISISTED_LIST_CHECK,()=>!this.candidateWasVisitedBefore(t.hash))){if(this.candidatesVisitedSet.add(t.hash),this.candidateSolvesMap(t.boxes))return t;await this.applyMoreActions(t)}}async applyMoreActions(t){for(const e of V.actionsList){const n=this.movementCoordinator.update({heroAction:e,hero:t.hero,boxes:t.boxes,lastActionResult:t.lastActionResult});if(n.mapChanged){const r=await this.metricEmitter.add(E.MOVE_ANALYSYS,()=>this.movementAnalyser.analyse(n)),o=100,l=e===B.STAND?o*.95:o;let c=0;r.pushedBox&&(r.pushedBox.id!==t.lastPushedBox.id||r.pushedBox.direction!==t.lastPushedBox.direction)&&(c=1);const g=r.sumOfEveryBoxToTheClosestTarget>=t.distanceSum?t.counterIntuitiveMoves+1:t.counterIntuitiveMoves,T={lastPushedBox:r.pushedBox||t.lastPushedBox,boxesLine:t.boxesLine+c,boxes:n.boxes.map(x=>({point:x.nextPosition,id:x.id})),hero:{point:n.hero.nextPosition,id:n.hero.id},actions:t.actions.concat(e),lastActionResult:n,counterIntuitiveMoves:g,distanceSum:t.distanceSum+l+r.sumOfEveryBoxToTheClosestTarget};T.hash=await this.metricEmitter.add(E.HASH_CALCULATION,()=>this.calculateHashOfSolution(T)),r.isDeadLocked||await this.metricEmitter.add(E.ADD_CANDIDATE,()=>this.candidatesToVisit.push(T))}}}candidateSolvesMap(t){return t.every(e=>this.getStaticFeaturesAtPosition(e.point).some(n=>n.code===d.target))}candidateWasVisitedBefore(t){return this.candidatesVisitedSet.has(t)}calculateHashOfSolution(t){return`${t.boxes.map(e=>{var n,r;return`${e.point.x},${e.point.y}(${((r=(n=t.lastActionResult)==null?void 0:n.boxes.find(o=>o.id===e.id))==null?void 0:r.direction)||"-"})`}).sort().join(";")}:${t.hero.point.x},${t.hero.point.y}`}getStaticFeaturesAtPosition(t){return t.x<this.strippedMap.width&&t.y<this.strippedMap.height&&t.x>=0&&t.y>=0?this.strippedMap.strippedFeatureLayeredMatrix[t.y][t.x]:[]}};let N=V;p(N,"actionsList",Object.keys(B).filter(t=>!isNaN(Number(t))).map(t=>Number(t)));const Q=i=>{const t=new Map;for(let[e,n]of i.entries())t.set(e,n.map(r=>{const o=r;return new A(o._x,o._y)}));return t};let b;console.log("solver running"),self.onmessage=async function(i){console.log("solver got message"),b&&b.abort();let t;try{b=new N({staticFeatures:Q(i.data.staticFeatures),strippedMap:i.data.strippedMap}),t=setTimeout(()=>{throw console.log("timed out"),b==null||b.abort(),b=void 0,Error("Solver timedout")},i.data.timeoutInMs),console.log("Starting map solver");const e=await b.solve(Q(i.data.dynamicMap));console.log(e),console.log("Map solved"),self.postMessage({solutionOutput:e})}catch(e){console.log("Solver aborted",e),self.postMessage({error:e,aborted:!0})}clearTimeout(t)}})();
